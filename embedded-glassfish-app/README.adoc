# A simple servlet application on Eclipse GlassFish Embedded 7

## Build

```
mvn clean package
```

## Run with Maven

```
mvn exec:exec
```

Then access the app at http://localhost:8080


You can specify a different HTTP port on the command line:

```
mvn exec:exec -Dhttp.port=9090
```

## Run with plain `java` command

```
java --add-opens java.base/java.lang=ALL-UNNAMED --add-opens=java.naming/javax.naming.spi=ALL-UNNAMED -cp 'target/classes:target/dependencies/*' ee.omnifish.glassfish.vt.EmbeddedGlassfishApp
```

NOTE: On Java 17, it's necessary to add the
`--add-opens java.base/java.lang=ALL-UNNAMED --add-opens=java.naming/javax.naming.spi=ALL-UNNAMED` JVM arguments.

## Memory usage

Memory statistics:

```
grep ^Vm /proc/`pgrep -f playwithloom`/status
```

* `VmPeak` - maximum virtual memory allocated
* `VmHWM` - Maximum RSS memory used

Set stack size:

```
java -Xss1m
``` 

## Bombardier

https://github.com/codesenberg/bombardier

Example - 12000 concurrent requets for 10 seconds:

bin/bombardier-linux-amd64 -c 12000
!http://localhost:8080

### Results

[cols="1,1,1,1a,1,1"]
|===
| Description | Max Threads | Sleep 
| Stack Depth 
| Statistics | Memory Usage | Command

| new platform thread per request 
| Unlimited
| ~500ms
| 100
| broken pipe
| N/A
| `java -Dsleep=500 fish.payara.codingdojo.playwithloom.ServerWithPlatformThreads`

| new platform thread per request
| Unlimited
| ~100ms 
| 100
| broken pipe
| N/A
| `java -Dsleep=100 fish.payara.codingdojo.playwithloom.ServerWithPlatformThreads`

| platform threads with executor
| 10,000 
| ~100ms
| 100
|[cols="1,1,1,1"]
!===
!
!Avg
!Stddev
!Max

!Reqs/sec
!22216.59
!8850.35
!58666.78

!Latency
!524.36ms
!54.32ms
!820.21ms
!===
| 4GB
|`java -Dsleep=100 -Dthreads=10000 fish.payara.codingdojo.playwithloom.ServerWithPlatformThreadsExecutor `

| virtual thread per request
| Unlimited
| ~100ms
| 100
|[cols="1,1,1,1"]
!===
!
!Avg
!Stddev
!Max

!Reqs/sec
!25895.12
!10999.52
!71947.40

!Latency
!452.97ms
!61.79ms
!0.98s
!===
| N/A
|`java -Dsleep=100 fish.payara.codingdojo.playwithloom.ServerWithLoom `

| virtual thread per request (limited)
| 10000
| ~100ms
| 100
|[cols="1,1,1,1"]
!===
!
!Avg
!Stddev
!Max

!Reqs/sec
!25339.48
!8856.82
!58473.20

!Latency
!461.47ms
!57.98ms
!735.65ms
!===
| 4.7GB
|`java -Dsleep=100 -Dthreads=10000 fish.payara.codingdojo.playwithloom.ServerWithLoomLimited`

|===


## Apache Benchmark

https://httpd.apache.org/

`ulimit -n 100000` - increase allowed file descriptors (open connections) from default 1024 to 100000

`ulimit -u` - number of processes allowed for user. E.g. `ulimit -u 120000`. Must be less than a hard limit set in the system

`cat /proc/sys/kernel/threads-max` - max number of processes in the system (increase with `echo 100000 > /proc/sys/kernel/threads-max`

Example - 10000 concurrent requets, 50000 in total

```
ab -n 50000 -c 10000 http://localhost:8080/
```